{
    "Search rules": [
        {
            "Bilibili": [
                "// 对 imgKey 和 subKey 进行字符顺序打乱编码",
                "const mixinKeyEncTab = [46, 47, 18, 2, 53, 8, 23, 32, 15, 50, 10, 31, 58, 3, 45, 35, 27, 43, 5, 49, 33, 9, 42, 19, 29, 28, 14, 39, 12, 38, 41, 13, 37, 48, 7, 16, 24, 55, 40, 61, 26, 17, 0, 1, 60, 51, 30, 4, 22, 25, 54, 21, 56, 59, 6, 63, 57, 62, 11, 36, 20, 34, 44, 52];",
                "",
                "function getMixinKey(orig) {",
                "    return mixinKeyEncTab.map((n) => orig[n]).join(\"\").slice(0, 32);",
                "}",
                "",
                "async function getBuvidValues() {",
                "    try {",
                "        const response = await fetch(\"https://www.bilibili.com/\", {",
                "            headers: {",
                "                \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36\"",
                "            }",
                "        });",
                "",
                "        const cookies = response.headers.get('set-cookie');",
                "        if (cookies) {",
                "            const buvid3 = cookies.match(/buvid3=[^;]+/)?.[0];",
                "            const buvid4 = cookies.match(/buvid4=[^;]+/)?.[0];",
                "            return `${buvid3}; ${buvid4}`;",
                "        }",
                "",
                "        const data = await fetch(\"https://api.bilibili.com/x/frontend/finger/spi\").then(r => r.json());",
                "        if (data.code === 0) return data.data.b_3;",
                "        throw new Error(\"Failed to get buvid values\");",
                "    } catch (error) {",
                "        console.error(\"Failed to get cookies:\", error);",
                "        throw error;",
                "    }",
                "}",
                "",
                "function encWbi(params, imgKey, subKey) {",
                "    const mixinKey = getMixinKey(imgKey + subKey);",
                "    const currTime = Math.round(Date.now() / 1000);",
                "    params.wts = currTime;",
                "",
                "    const query = Object.keys(params).sort().map((key) => {",
                "        const value = params[key].toString().replace(/[!'()*]/g, \"\");",
                "        return `${encodeURIComponent(key)}=${encodeURIComponent(value)}`;",
                "    }).join(\"&\");",
                "",
                "    const wbiSign = md5(query + mixinKey);",
                "    return `${query}&w_rid=${wbiSign}`;",
                "}",
                "",
                "async function getWbiKeys(sessdata = \"\") {",
                "    const response = await fetch(\"https://api.bilibili.com/x/web-interface/nav\", {",
                "        headers: {",
                "            Cookie: `SESSDATA=${sessdata}`,",
                "            \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36\"",
                "        }",
                "    });",
                "",
                "    const json = await response.json();",
                "    const { img_url, sub_url } = json.data.wbi_img;",
                "",
                "    return {",
                "        img_key: img_url.slice(img_url.lastIndexOf(\"/\") + 1, img_url.lastIndexOf(\".\")),",
                "        sub_key: sub_url.slice(sub_url.lastIndexOf(\"/\") + 1, sub_url.lastIndexOf(\".\"))",
                "    };",
                "}",
                "",
                "async function searchBilibiliVideo(keyword, search_type = \"video\", page = 1, order = \"totalrank\", duration = 0, tids = 0) {",
                "    const { img_key, sub_key } = await getWbiKeys();",
                "    const params = { search_type, keyword, order, duration, tids, page };",
                "    const query = encWbi(params, img_key, sub_key);",
                "",
                "    const response = await fetch(`https://api.bilibili.com/x/web-interface/wbi/search/type?${query}`, {",
                "        headers: {",
                "            \"User-Agent\": \"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36\",",
                "            Referer: \"https://www.bilibili.com/\"",
                "        }",
                "    });",
                "",
                "    const json = await response.json();",
                "    return json.data.result;",
                "}",
                "",
                "async function main(keyword) {",
                "    return await searchBilibiliVideo(keyword, 1);",
                "}"
            ]
        }
    ],
    "Music link": [
        {
            "Bilibili": [
                "async function getCid(videoId, isBvid = true) {",
                "    const params = new URLSearchParams(isBvid ? {bvid: videoId} : {avid: videoId});",
                "    const response = await fetch(`https://api.bilibili.com/x/web-interface/view?${params}`, {",
                "        headers: {",
                "            Referer: 'https://www.bilibili.com',",
                "            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)'",
                "        }",
                "    });",
                "",
                "    const data = await response.json();",
                "    if (data.code !== 0) throw new Error(data.message || '获取视频信息失败');",
                "    if (!data.data.cid) throw new Error('未找到Cid');",
                "    return data.data.cid;",
                "}",
                "",
                "async function getAudioLink(videoId, isBvid = true) {",
                "    const cid = await getCid(videoId, isBvid);",
                "    const params = new URLSearchParams({",
                "        ...(isBvid ? {bvid: videoId} : {avid: videoId}),",
                "        cid,",
                "        fnval: 16,",
                "        fnver: 0,",
                "        fourk: 1",
                "    });",
                "",
                "    const response = await fetch(`https://api.bilibili.com/x/player/playurl?${params}`, {",
                "        headers: {",
                "            Referer: 'https://www.bilibili.com',",
                "            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64)'",
                "        }",
                "    });",
                "",
                "    const data = await response.json();",
                "    if (data.code !== 0) throw new Error(data.message || '获取音频链接失败');",
                "",
                "    const audioStream = data.data.dash.audio;",
                "    if (!audioStream?.length) throw new Error('未找到音频流');",
                "",
                "    const bestAudio = audioStream[0];",
                "    return [bestAudio.baseUrl, bestAudio.backupUrl];",
                "}",
                "",
                "async function main(bvid) {",
                "    try {",
                "        return await getAudioLink(bvid, true);",
                "    } catch (error) {",
                "        console.error('无法获取音频链接:', error.message);",
                "    }",
                "}"
            ]
        }
    ]
}
